name: Build and Deploy

on:
  workflow_run:
    workflows: ["Sync Documents"]
    types: [completed]
  workflow_dispatch:
    inputs:
      redeploy_only:
        description: '仅重新部署（跳过下载）'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Log Build Info
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 开始构建前端"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 仓库: ${{ github.repository }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 触发事件: ${{ github.event_name }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 触发 workflow: ${{ github.event.workflow_run.name }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 触发 workflow ID: ${{ github.event.workflow_run.id }}"

      - name: Checkout Main Repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            reader/config.json
            scripts/sync.py
          sparse-checkout-cone-mode: false

      - name: Download Workspace Artifact
        if: ${{ github.event_name == 'workflow_run' || github.event.inputs.redeploy_only != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: workspace
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Artifact Content
        if: ${{ github.event_name == 'workflow_run' || github.event.inputs.redeploy_only != 'true' }}
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 验证 artifact 内容"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 根目录内容:"
          ls -la
          echo ""
          if [ -d txt ]; then
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] txt 目录存在"
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] txt 目录内容:"
            ls -la txt/
            echo ""
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] txt 目录大小:"
            du -sh txt/
          else
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] txt 目录不存在"
          fi
          echo ""
          if [ -d reader ]; then
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] reader 目录存在"
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] reader 目录内容:"
            ls -la reader/
            echo ""
            if [ -d reader/docs ]; then
              echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] reader/docs 目录内容:"
              ls -la reader/docs/
            fi
          else
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] reader 目录不存在"
          fi
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="

      - name: Checkout Frontend from front-text
        uses: actions/checkout@v4
        with:
          repository: coolapijust/front-text
          path: frontend
          sparse-checkout: |
            reader/css
            reader/app.js
            reader/index.html
          sparse-checkout-cone-mode: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install -q python-docx mammoth

      - name: Verify sync.py Version
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 验证 sync.py 版本"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] scripts/sync.py 路径: $(ls -la scripts/sync.py)"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 检查是否包含调试信息:"
          grep -n "配置中的 source_dir_name" scripts/sync.py || echo "未找到调试信息"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="

      - name: Verify txt Directory
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 验证 txt 目录"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 当前目录: $(pwd)"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 根目录内容:"
          ls -la
          echo ""
          if [ -d txt ]; then
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] txt 目录存在"
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] txt 目录内容:"
            ls -la txt/
          else
            echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] txt 目录不存在"
          fi
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="

      - name: Run Sync Script
        env:
          SYNC_ROOT_DIR: ${{ github.workspace }}
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 运行 sync.py 生成文档"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] github.workspace: ${{ github.workspace }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] SYNC_ROOT_DIR: $SYNC_ROOT_DIR"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 当前目录: $(pwd)"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          python scripts/sync.py
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 文档生成完成"

      - name: Merge Frontend
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 合并前端文件"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          cp -r frontend/reader/* reader/
          rm -rf frontend
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 前端合并完成"

      - name: Verify Build
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 验证构建产物..."
          ls -la reader/
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 文件清单:"
          find reader -type f | sort

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: reader/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Log Deployment Summary
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 部署完成"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 页面 URL: ${{ steps.deployment.outputs.page_url }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="

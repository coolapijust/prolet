name: Sync Documents

on:
  workflow_dispatch:
    inputs:
      github_repo:
        description: 'GitHub 仓库地址 (例如: owner/repo)'
        required: false
        default: ''

permissions:
  contents: write

concurrency:
  group: "sync-docs"
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Log Deployment Info
        run: |
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 开始同步文档"
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 仓库: ${{ github.repository }}"
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 触发方式: ${{ github.event_name }}"
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 工作目录: ${{ github.workspace }}"
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 运行器: ${{ runner.os }}"
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          pwd
          ls -la

      - name: Checkout Main Repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            txt
            scripts/download-files.py
            reader/config.json
          sparse-checkout-cone-mode: false

      - name: Checkout Frontend from front-text
        uses: actions/checkout@v4
        with:
          repository: coolapijust/front-text
          path: frontend
          sparse-checkout: |
            scripts/sync.py
          sparse-checkout-cone-mode: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Verify Files
        run: |
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 验证文件存在"
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          ls -la reader/
          echo ""
          if [ -f reader/config.json ]; then
            echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] reader/config.json 存在"
          else
            echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] reader/config.json 不存在"
          fi
          echo ""
          if [ -f scripts/download-files.py ]; then
            echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] scripts/download-files.py 存在"
          else
            echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] scripts/download-files.py 不存在"
          fi

      - name: Cache SHA Cache
        uses: actions/cache@v4
        with:
          path: .github/file-sha-cache.json
          key: ${{ runner.os }}-sha-cache-${{ hashFiles('reader/config.json', 'scripts/download-files.py') }}
          restore-keys: |
            ${{ runner.os }}-sha-cache-

      - name: Install Dependencies
        run: |
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 安装依赖..."
          pip install -q python-docx mammoth
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 依赖安装完成"

      - name: Download TXT Files via API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO_OVERRIDE: ${{ github.event.inputs.github_repo }}
        run: |
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 使用 GitHub API 下载文件..."
          python scripts/download-files.py
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 文件下载完成"

      - name: Run Sync Script
        env:
          SYNC_ROOT_DIR: ${{ github.workspace }}
        run: |
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 扫描并同步文件..."
          python frontend/scripts/sync.py
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 文件同步完成"

      - name: Upload Reader Artifact
        uses: actions/upload-artifact@v4
        with:
          name: reader
          path: reader/
          retention-days: 1
          compression-level: 6

      - name: Log Sync Summary
        run: |
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 同步任务完成"
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="

      - name: Save Cache on Failure
        if: failure()
        run: |
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 保存缓存（失败时）"
          echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          if [ -f .github/file-sha-cache.json ]; then
            echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 缓存文件存在"
            cat .github/file-sha-cache.json
          else
            echo "[Sync][$(date +%Y-%m-%d\ %H:%M:%S)] 缓存文件不存在"
          fi

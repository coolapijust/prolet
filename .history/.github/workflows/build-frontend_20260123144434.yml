name: Build and Deploy

on:
  workflow_run:
    workflows: ["Sync Documents"]
    types: [completed]
  workflow_dispatch:
    inputs:
      redeploy_only:
        description: '仅重新部署（跳过下载）'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Log Build Info
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 开始构建前端"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 仓库: ${{ github.repository }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 触发事件: ${{ github.event_name }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 触发 workflow: ${{ github.event.workflow_run.name }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 触发 workflow ID: ${{ github.event.workflow_run.id }}"

      - name: Checkout Main Repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            reader/config.json
          sparse-checkout-cone-mode: false

      - name: List Available Artifacts
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.redeploy_only != 'true' }}
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 列出可用的 artifact"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] Workflow Run ID: ${{ github.event.workflow_run.id }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 仓库: ${{ github.repository }}"
          echo ""
          
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 列出所有 artifacts:"
          gh run view ${{ github.event.workflow_run.id }} \
            --repo ${{ github.repository }} \
            --json artifacts \
            --jq '.artifacts[] | {name: .name, size: .size, expired: .expired}'
          
          echo ""
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 尝试下载 reader artifact..."
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download Reader Artifact
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.redeploy_only != 'true' }}
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 下载 reader artifact"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] Workflow Run ID: ${{ github.event.workflow_run.id }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 仓库: ${{ github.repository }}"
          echo ""
          
          gh artifact download reader \
            --run-id ${{ github.event.workflow_run.id }} \
            --dir reader \
            --repo ${{ github.repository }}
          
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] Artifact 下载完成"
          ls -la reader/
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Skip Download Message
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.redeploy_only == 'true' }}
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 跳过下载，仅重新部署"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 使用现有的 reader/ 目录内容"

      - name: Checkout Frontend from front-text
        uses: actions/checkout@v4
        with:
          repository: coolapijust/front-text
          path: frontend
          sparse-checkout: |
            reader/css
            reader/app.js
            reader/index.html
          sparse-checkout-cone-mode: false

      - name: Merge Frontend
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 合并前端文件..."
          cp -r frontend/reader/* reader/
          rm -rf frontend
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 前端合并完成"

      - name: Verify Build
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 验证构建产物..."
          ls -la reader/
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 文件清单:"
          find reader -type f | sort

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Log Deployment Summary
        run: |
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 部署完成"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] 页面 URL: ${{ steps.deployment.outputs.page_url }}"
          echo "[Build][$(date +%Y-%m-%d\ %H:%M:%S)] ==========================================="
